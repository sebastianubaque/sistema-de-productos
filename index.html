<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Productos con Variaciones</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }
    .header h1 { margin: 0; font-size: 28px; font-weight: 700; }
    .counter {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      margin-top: 12px;
      display: inline-block;
      font-weight: 600;
    }
    .connection-status {
      background: rgba(255,255,255,0.15);
      padding: 12px 20px;
      border-radius: 25px;
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
    }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #28a745; }
    .form-section { padding: 24px; }
    .product-type-selector { display: flex; gap: 12px; margin-bottom: 24px; justify-content: center; }
    .type-btn {
      padding: 12px 24px; border: 2px solid #e1e5e9; background: white; border-radius: 12px;
      cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 16px;
    }
    .type-btn:hover { border-color: #4facfe; transform: translateY(-2px); }
    .type-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
    .form-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(3, 1fr); } }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 8px; color: #333; display: flex; align-items: center; gap: 8px; }
    .form-group input, .form-group select {
      padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: white;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79,172,254,0.1); }
    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px;
      border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; transition: all 0.3s ease;
    }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.3); }
    .submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    .clear-form-btn {
      background: #6c757d; color: white; border: none; padding: 16px 24px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all .3s;
    }
    .clear-form-btn:hover { background: #5a6268; transform: translateY(-1px); }
    .add-variation-btn {
      background: #28a745; color: white; border: none; padding: 16px 24px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all .3s;
    }
    .add-variation-btn:hover { background: #218838; transform: translateY(-1px); }
    .form-actions { display: flex; gap: 12px; width: 100%; grid-column: 1 / -1; }
    @media (max-width: 767px) { .form-actions { flex-direction: column; } }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 900px; width: 100%; max-height: 90%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e1e5e9; }
    .modal-title { font-size: 24px; font-weight: 700; color: #333; margin: 0; }
    .close-modal-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all .3s; }
    .close-modal-btn:hover { background: #c82333; }

    .variation-item {
      background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px;
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;
    }
    @media (max-width: 767px) { .variation-item { grid-template-columns: 1fr; } }
    .remove-variation-btn { background: #dc3545; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .add-more-variation-btn { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 12px; }
    .save-variations-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px; }

    .products-section { padding: 24px; border-top: 1px solid #e1e5e9; }
    .section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .section-title { font-size: 20px; font-weight: 700; color: #333; }
    .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
    .clear-all-btn, .download-btn { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all .3s; }
    .clear-all-btn { background: #dc3545; color: white; }
    .clear-all-btn:hover { background: #c82333; transform: translateY(-1px); }
    .download-btn { background: #28a745; color: white; }
    .download-btn:hover { background: #218838; transform: translateY(-1px); }
    #refreshBtn { background: #4c6ef5; } #refreshBtn:hover { background: #3b5bdb; }
    #refreshBtn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .empty-state { text-align: center; padding: 40px; color: #6c757d; }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .product-simple {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: 2px solid #28a745; border-radius: 16px;
      padding: 20px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(40,167,69,0.15);
    }
    .product-with-variations {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 16px;
      padding: 20px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(255,152,0,0.15);
    }
    .variations-list { margin-top: 16px; display: grid; gap: 12px; }
    .variation-card { background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800; }
    .category-info-badge {
      background: rgba(255,152,0,.2); color: #e65100; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; display: inline-block; margin-top: 8px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="font-size: 14px; margin-bottom: 8px; opacity: .9;">Version 0002</div>
      <h1 id="appTitle">Sistema de Productos con Variaciones</h1>
      <div class="counter" id="productCounter">Productos: 0</div>
      <div class="connection-status" id="connectionStatus">
        <div class="status-indicator" id="statusDot"></div>
        <span id="statusText">Conectando‚Ä¶</span>
      </div>
      <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
        <button class="download-btn" onclick="analyzeDatabase()" id="analyzeBtn" style="display:inline-block;background:#17a2b8;padding:12px 24px;font-size:16px;">üîÑ Analizar Base de Datos</button>
        <button class="download-btn" onclick="openImportModal()" id="importBtn" style="display:inline-block;background:#ff9800;padding:12px 24px;font-size:16px;">üì§ Importar CSV</button>
        <button class="download-btn" id="refreshBtn" style="display:inline-block;background:#4c6ef5;padding:12px 24px;font-size:16px;">üîÅ Recargar de Sheets</button>
      </div>
    </div>

    <div class="form-section">
      <div class="product-type-selector">
        <button class="type-btn active" onclick="setProductType('simple')" id="simpleBtn">üì¶ Producto Simple</button>
        <button class="type-btn" onclick="setProductType('variations')" id="variationsBtn">üé® Producto con Variaciones</button>
      </div>

      <form id="productForm" class="form-grid">
        <div class="form-group">
          <label for="marca">Marca *</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button type="button" onclick="showQuickAddModal('marca', 'marca')" style="background:#28a745;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
            <input type="text" id="marca" name="marca" required list="marcasList" placeholder="Escribe o selecciona una marca..." style="text-transform:uppercase;flex:1;" autocomplete="off">
          </div>
          <datalist id="marcasList"></datalist>
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n *</label>
          <input type="text" id="descripcion" name="descripcion" required placeholder="Ej: JEAN, BLUSA, PANTALON..." style="text-transform:uppercase;">
        </div>

        <div class="form-group">
          <label for="genero">G√©nero</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <button type="button" onclick="showQuickAddModal('genero', 'genero')" style="background:#28a745;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
            <input type="text" id="genero" name="genero" list="generosList" placeholder="Escribe o selecciona un g√©nero..." style="text-transform:uppercase;flex:1;" autocomplete="off">
          </div>
          <datalist id="generosList"></datalist>
        </div>

        <div class="form-group">
          <label for="precioCompra">Precio de Compra *</label>
          <input type="number" id="precioCompra" name="precioCompra" step="0.01" min="0" placeholder="0.00" required>
        </div>

        <div class="form-group">
          <label for="precioVenta">Precio de Venta *</label>
          <input type="number" id="precioVenta" name="precioVenta" step="0.01" min="0" placeholder="0.00" required>
        </div>

        <!-- Solo simple -->
        <div class="form-group" id="estiloGroup">
          <label for="estilo">Estilo</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <button type="button" onclick="showQuickAddModal('estilo','estilo')" style="background:#28a745;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
            <input type="text" id="estilo" name="estilo" list="estilosList" placeholder="Escribe o selecciona un estilo..." style="text-transform:uppercase;flex:1;" autocomplete="off">
          </div>
          <datalist id="estilosList"></datalist>
        </div>

        <div class="form-group" id="colorGroup">
          <label for="color">Color</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <button type="button" onclick="showQuickAddModal('color','color')" style="background:#28a745;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
            <input type="text" id="color" name="color" list="coloresList" placeholder="Escribe o selecciona un color..." style="text-transform:uppercase;flex:1;" autocomplete="off">
          </div>
          <datalist id="coloresList"></datalist>
        </div>

        <div class="form-group" id="tallaGroup">
          <label for="talla">Talla</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <button type="button" onclick="showQuickAddModal('talla','talla')" style="background:#28a745;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
            <input type="text" id="talla" name="talla" list="tallasList" placeholder="Escribe o selecciona una talla..." style="text-transform:uppercase;flex:1;" autocomplete="off">
          </div>
          <datalist id="tallasList"></datalist>
        </div>

        <div class="form-group" id="cantidadGroup">
          <label for="cantidad">Cantidad *</label>
          <input type="number" id="cantidad" name="cantidad" min="0" placeholder="0" required>
        </div>

        <div class="form-actions">
          <button type="submit" class="submit-btn" id="submitBtn">‚ú® Crear Producto</button>
          <button type="button" class="clear-form-btn" onclick="clearForm()">üóëÔ∏è Limpiar</button>
          <button type="button" class="add-variation-btn" id="openVariationsBtn" onclick="openVariationsModal()" style="display:none;">+ Agregar Producto Variable</button>
        </div>
      </form>
    </div>

    <div class="products-section">
      <div class="section-header">
        <h2 class="section-title">üìã Productos Registrados</h2>
        <div class="action-buttons">
          <button class="download-btn" onclick="downloadCSV()" id="downloadBtn" style="display:none;">üì• Descargar CSV</button>
          <button class="clear-all-btn" onclick="clearAllProducts()" id="clearAllBtn" style="display:none;">üóëÔ∏è Limpiar Todo</button>
        </div>
      </div>

      <div id="filterSection" style="display:none;margin-bottom:24px;background:#f8f9fa;padding:20px;border-radius:12px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">üîç Buscar:</label>
            <input type="text" id="searchInput" placeholder="Buscar por marca, descripci√≥n, color..." oninput="applyFilters()" style="width:100%;padding:10px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;">
          </div>
          <div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">üìÇ Filtrar por Categor√≠a:</label>
            <select id="categoryFilter" onchange="applyFilters()" style="width:100%;padding:10px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;">
              <option value="">Todas las categor√≠as</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">üè¢ Filtrar por Marca:</label>
            <select id="brandFilter" onchange="applyFilters()" style="width:100%;padding:10px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;">
              <option value="">Todas las marcas</option>
            </select>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;">
          <div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">üìä Ordenar por:</label>
            <select id="sortBy" onchange="applyFilters()" style="width:100%;padding:10px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;">
              <option value="fecha-desc">M√°s recientes primero</option>
              <option value="fecha-asc">M√°s antiguos primero</option>
              <option value="marca-asc">Marca (A-Z)</option>
              <option value="marca-desc">Marca (Z-A)</option>
              <option value="descripcion-asc">Descripci√≥n (A-Z)</option>
              <option value="descripcion-desc">Descripci√≥n (Z-A)</option>
              <option value="cantidad-desc">Mayor cantidad</option>
              <option value="cantidad-asc">Menor cantidad</option>
              <option value="precio-desc">Mayor precio</option>
              <option value="precio-asc">Menor precio</option>
              <option value="ganancia-desc">Mayor ganancia</option>
              <option value="ganancia-asc">Menor ganancia</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">üì¶ Tipo de Producto:</label>
            <select id="typeFilter" onchange="applyFilters()" style="width:100%;padding:10px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;">
              <option value="">Todos los tipos</option>
              <option value="simple">Solo productos simples</option>
              <option value="variation">Solo con variaciones</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <button onclick="resetFilters()" style="width:100%;background:#6c757d;color:white;border:none;padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">üîÑ Limpiar Filtros</button>
          </div>
        </div>

        <div id="filterResults" style="margin-top:16px;padding:12px;background:white;border-radius:8px;text-align:center;font-weight:600;color:#667eea;"></div>
      </div>

      <div id="emptyState" class="empty-state">
        <div class="empty-state-icon">üì¶</div>
        <p><strong>No hay productos registrados</strong></p>
        <p>Crea tu primer producto usando el formulario de arriba</p>
      </div>

      <div id="productsContainer"></div>
    </div>
  </div>

  <!-- Modal de Variaciones -->
  <div id="variationsModal" style="display:none;"></div>
  <!-- Modal de Edici√≥n -->
  <div id="editModal" style="display:none;"></div>

  <script>
    /* ================================
       CONFIG API (TU WEB APP)
       ================================ */
    const API_URL = "https://script.google.com/macros/s/AKfycbyrYVNRXXzUSDciYw8IqHT3lEMHMZLgNgzXK8EDkMmzruPHVr0RVMEynq6eDaxoez-6vg/exec";

    /* ================================
       ESTADO EN MEMORIA
       ================================ */
    let currentProducts = [];
    let filteredProducts = [];
    let currentProductType = 'simple';
    let tempVariations = [];
    let dataOptions = { MARCA: [], GENERO: [], ESTILO: [], COLOR: [], TALLA: [] };

    /* ================================
       UTILIDADES
       ================================ */
    function getFieldValue(id){ const el=document.getElementById(id); return (el.value||'').toUpperCase().trim(); }
    function setProductType(type) {
      currentProductType = type;
      const simpleBtn = document.getElementById('simpleBtn');
      const variationsBtn = document.getElementById('variationsBtn');
      const estiloGroup = document.getElementById('estiloGroup');
      const colorGroup = document.getElementById('colorGroup');
      const tallaGroup = document.getElementById('tallaGroup');
      const cantidadGroup = document.getElementById('cantidadGroup');
      const openVariationsBtn = document.getElementById('openVariationsBtn');
      const submitBtn = document.getElementById('submitBtn');

      if (type === 'simple') {
        simpleBtn.classList.add('active'); variationsBtn.classList.remove('active');
        estiloGroup.style.display = 'flex'; colorGroup.style.display = 'flex';
        tallaGroup.style.display = 'flex'; cantidadGroup.style.display = 'flex';
        openVariationsBtn.style.display = 'none'; submitBtn.style.display = 'block';
        submitBtn.textContent = '‚ú® Crear Producto';
      } else {
        simpleBtn.classList.remove('active'); variationsBtn.classList.add('active');
        estiloGroup.style.display = 'none'; colorGroup.style.display = 'none';
        tallaGroup.style.display = 'none'; cantidadGroup.style.display = 'none';
        openVariationsBtn.style.display = 'block'; submitBtn.style.display = 'none';
      }
    }
    function showMessage(title,msg,color='#28a745'){ const t=document.getElementById('statusText'); const d=document.getElementById('statusDot'); t.textContent=`${title} ‚Äî ${msg}`; d.style.background=(color==='#dc3545')?'#dc3545':'#28a745'; setTimeout(()=>{t.textContent='Conectado a Google Sheets'; d.style.background='#28a745';},3000);}
    function updateCounter(){ document.getElementById('productCounter').textContent = `Productos: ${currentProducts.length}`;}

    /* ================================
       API HELPER (CORS SAFE)
       ================================ */
    async function apiCall(action, body = {}) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" }, // evita preflight CORS
        body: JSON.stringify({ action, ...body })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Error en API');
      return json;
    }

    /* ================================
       NORMALIZACI√ìN (Sheets ‚Üí UI)
       ================================ */
    function normalizeProduct(p){
      return {
        id: String(p.ID || ''),
        tipo: (p.TIPO || '').toUpperCase() === 'VARIACION' ? 'variation' : 'simple',
        marca: (p.MARCA || '').toUpperCase(),
        descripcion: (p.DESCRIPCION || '').toUpperCase(),
        genero: (p.GENERO || '').toUpperCase(),
        estilo: (p.ESTILO || '').toUpperCase(),
        color: (p.COLOR || '').toUpperCase(),
        talla: (p.TALLA || '').toUpperCase(),
        cantidad: Number(p.CANTIDAD || 0),
        precioCompra: Number(p.PRECIOCOMPRA || 0),
        precioVenta: Number(p.PRECIOVENTA || 0),
        fechaCreacion: p.FECHACREACION || '',
        categoria: (p.CATEGORIA || '').toUpperCase()
      };
    }

    /* ================================
       DATALISTS
       ================================ */
    function fillDatalist(id, values){ const dl=document.getElementById(id); if(!dl) return; dl.innerHTML=''; (values||[]).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); }); }
    function refreshDatalists(){ fillDatalist('generosList',dataOptions.GENERO); fillDatalist('estilosList',dataOptions.ESTILO); fillDatalist('coloresList',dataOptions.COLOR); fillDatalist('tallasList',dataOptions.TALLA); fillDatalist('marcasList',dataOptions.MARCA); }

    /* ================================
       CARGA INICIAL
       ================================ */
    async function loadAll(){
      try{
        document.getElementById('statusText').textContent='Cargando datos de Sheets‚Ä¶';
        const [prodRes, dataRes] = await Promise.all([ apiCall('list_products'), apiCall('list_data') ]);
        const rows = Array.isArray(prodRes.data) ? prodRes.data : [];
        currentProducts = rows.map(normalizeProduct);
        filteredProducts = [...currentProducts];
        updateProductsDisplay(); updateCounter();

        dataOptions = Object.assign({MARCA:[],GENERO:[],ESTILO:[],COLOR:[],TALLA:[]}, dataRes.data || {});
        refreshDatalists();

        document.getElementById('statusText').textContent='Conectado a Google Sheets';
        document.getElementById('statusDot').style.background='#28a745';
      }catch(err){
        console.error(err);
        document.getElementById('statusText').textContent='Error al conectar con Sheets';
        document.getElementById('statusDot').style.background='#dc3545';
      }
    }

    /* ================================
       GUARDAR EN DATOS (sin duplicados por backend)
       ================================ */
    async function saveDataRowFromProduct(prod){
      const row = {
        MARCA: (prod.MARCA || prod.marca || '').toString().toUpperCase().trim(),
        GENERO:(prod.GENERO|| prod.genero|| '').toString().toUpperCase().trim(),
        ESTILO:(prod.ESTILO|| prod.estilo|| '').toString().toUpperCase().trim(),
        COLOR: (prod.COLOR || prod.color || '').toString().toUpperCase().trim(),
        TALLA: (prod.TALLA || prod.talla || '').toString().toUpperCase().trim()
      };
      const allEmpty = !row.MARCA && !row.GENERO && !row.ESTILO && !row.COLOR && !row.TALLA;
      if (allEmpty) return;
      try{ await apiCall('add_data_row', { row }); }catch(e){ console.warn('No se pudo guardar en DATOS:', e.message); }
    }

    /* ================================
       CATEGOR√çA
       ================================ */
    function generateCategory(descripcion,genero){
      const desc=(descripcion||'').toUpperCase().trim(); const gen=(genero||'').toUpperCase().trim();
      if(!desc) return gen?`SIN CATEGORIA ${gen}`:'SIN CATEGORIA';
      const palabras=['JEAN','JEANS','PANTALON','PANTAL√ìN','BLUSA','CAMISA','CAMISETA','CAMISILLA','VESTIDO','FALDA','CHAQUETA','SACO','ABRIGO','SHORT','BERMUDA','LEGGINS','LEGUIS','BUSO','SUDADERA','BODY','ENTERIZO','CONJUNTO','ZAPATO','TENIS','SANDALIA','BOTA','BOLSO','CARTERA','ACCESORIO','GORRA','SOMBRERO'];
      let tipo=''; for(const p of palabras){ if(desc.includes(p)){ tipo=p; break; } }
      if(!tipo) tipo=desc.split(' ')[0];
      return gen?`${tipo} ${gen}`:tipo;
    }

    /* ================================
       FORM SUBMIT (SIMPLE)
       ================================ */
    document.getElementById('productForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); if(currentProductType!=='simple') return;
      const btn=document.getElementById('submitBtn'); const orig=btn.textContent; btn.disabled=true; btn.textContent='üíæ Guardando‚Ä¶';
      try{
        const ID=`PROD_${Date.now()}`, TIPO='SIMPLE';
        const MARCA=getFieldValue('marca'), DESCRIPCION=getFieldValue('descripcion'), GENERO=getFieldValue('genero');
        const ESTILO=getFieldValue('estilo'), COLOR=getFieldValue('color'), TALLA=getFieldValue('talla');
        const CANTIDAD=parseInt(document.getElementById('cantidad').value)||0;
        const PRECIOCOMPRA=parseFloat(document.getElementById('precioCompra').value)||0;
        const PRECIOVENTA=parseFloat(document.getElementById('precioVenta').value)||0;

        if(!MARCA || !DESCRIPCION || !PRECIOCOMPRA || !PRECIOVENTA || !CANTIDAD){
          showMessage('Campos requeridos','Marca, Descripci√≥n, Precios y Cantidad son obligatorios.','#dc3545'); return;
        }

        const FECHACREACION = new Date().toISOString().slice(0,10);
        const CATEGORIA = generateCategory(DESCRIPCION, GENERO);
        const prod = { ID,TIPO,MARCA,DESCRIPCION,GENERO,ESTILO,COLOR,TALLA,CANTIDAD,PRECIOCOMPRA,PRECIOVENTA,FECHACREACION,CATEGORIA };

        await apiCall('create_products',{ products:[prod] });
        await saveDataRowFromProduct(prod);
        await loadAll(); showMessage('OK','Producto guardado correctamente.'); clearForm();
      }catch(err){ console.error(err); showMessage('Error', err.message, '#dc3545'); }
      finally{ btn.disabled=false; btn.textContent=orig; }
    });

    /* ================================
       VARIACIONES (MODAL)
       ================================ */
    function openVariationsModal(){
      const marca=getFieldValue('marca'), descripcion=getFieldValue('descripcion'), genero=getFieldValue('genero');
      const precioCompra=parseFloat(document.getElementById('precioCompra').value)||0;
      const precioVenta =parseFloat(document.getElementById('precioVenta').value)||0;
      if(!marca || !descripcion || !precioCompra || !precioVenta){ showMessage('Campos Requeridos','Completa Marca, Descripci√≥n y Precios antes de agregar variaciones.','#dc3545'); return; }

      const modal=document.getElementById('variationsModal'); modal.style.display='block';
      const colorOptions=(dataOptions.COLOR||[]).map(c=>`<option value="${c}">`).join('');
      const tallaOptions=(dataOptions.TALLA||[]).map(t=>`<option value="${t}">`).join('');
      const estiloOptions=(dataOptions.ESTILO||[]).map(e=>`<option value="${e}">`).join('');
      if(tempVariations.length===0) tempVariations.push({ id:Date.now(), estilo:'', color:'', talla:'', cantidad:0 });

      let html=''; tempVariations.forEach(v=>{
        html+=`
          <div class="variation-item" id="tempVar-${v.id}">
            <div class="form-group" style="margin:0;">
              <label>Estilo</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <button type="button" onclick="showQuickAddModal('estilo','varEstilo-${v.id}')" style="background:#28a745;color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:700;flex-shrink:0;">+</button>
                <input type="text" id="varEstilo-${v.id}" class="var-estilo" data-id="${v.id}" value="${v.estilo}" list="varEstiloList-${v.id}" placeholder="Escribe o selecciona..." style="text-transform:uppercase;padding:10px;border:2px solid #e1e5e9;border-radius:6px;font-size:14px;width:100%;" autocomplete="off">
              </div>
              <datalist id="varEstiloList-${v.id}">${estiloOptions}</datalist>
            </div>
            <div class="form-group" style="margin:0;">
              <label>Color</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <button type="button" onclick="showQuickAddModal('color','varColor-${v.id}')" style="background:#28a745;color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:700;flex-shrink:0;">+</button>
                <input type="text" id="varColor-${v.id}" class="var-color" data-id="${v.id}" value="${v.color}" list="varColorList-${v.id}" placeholder="Escribe o selecciona..." style="text-transform:uppercase;padding:10px;border:2px solid #e1e5e9;border-radius:6px;font-size:14px;width:100%;" autocomplete="off">
              </div>
              <datalist id="varColorList-${v.id}">${colorOptions}</datalist>
            </div>
            <div class="form-group" style="margin:0;">
              <label>Talla</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <button type="button" onclick="showQuickAddModal('talla','varTalla-${v.id}')" style="background:#28a745;color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">+</button>
                <input type="text" id="varTalla-${v.id}" class="var-talla" data-id="${v.id}" value="${v.talla}" list="varTallaList-${v.id}" placeholder="Escribe o selecciona..." style="text-transform:uppercase;padding:10px;border:2px solid #e1e5e9;border-radius:6px;font-size:14px;width:100%;" autocomplete="off">
              </div>
              <datalist id="varTallaList-${v.id}">${tallaOptions}</datalist>
            </div>
            <div class="form-group" style="margin:0;">
              <label>Cantidad</label>
              <input type="number" class="var-cantidad" data-id="${v.id}" value="${v.cantidad||''}" min="0" placeholder="0" style="padding:10px;border:2px solid #e1e5e9;border-radius:6px;font-size:14px;">
            </div>
            <button type="button" class="remove-variation-btn" onclick="removeTempVariation(${v.id})">X</button>
          </div>
        `;
      });

      modal.innerHTML=`
        <div class="modal-overlay">
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">Agregar Variaciones</h2>
              <button class="close-modal-btn" onclick="closeVariationsModal()">Cerrar</button>
            </div>
            <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;">
              <p style="margin:0;font-weight:600;color:#333;"><strong>Producto:</strong> ${marca} - ${descripcion}</p>
              <p style="margin:8px 0 0 0;color:#666;">
                <strong>G√©nero:</strong> ${genero || 'N/A'} |
                <strong>P. Compra:</strong> $${precioCompra.toFixed(2)} |
                <strong>P. Venta:</strong> $${precioVenta.toFixed(2)}
              </p>
            </div>
            <div id="variationsListModal">${html}</div>
            <button type="button" class="add-more-variation-btn" onclick="addTempVariation()">+ Agregar Otra Variaci√≥n</button>
            <button type="button" class="save-variations-btn" onclick="saveAllVariations()">üíæ Guardar Todas las Variaciones</button>
          </div>
        </div>`;
      attachVariationInputListeners();
    }
    function attachVariationInputListeners(){ document.querySelectorAll('.var-estilo,.var-color,.var-talla,.var-cantidad').forEach(inp=>{ inp.addEventListener('input',function(){ const id=parseInt(this.dataset.id); const v=tempVariations.find(x=>x.id===id); if(!v) return; if(this.classList.contains('var-estilo')) v.estilo=this.value.toUpperCase().trim(); if(this.classList.contains('var-color')) v.color=this.value.toUpperCase().trim(); if(this.classList.contains('var-talla')) v.talla=this.value.toUpperCase().trim(); if(this.classList.contains('var-cantidad')) v.cantidad=parseInt(this.value)||0; }); }); }
    function addTempVariation(){ let last={estilo:'',color:'',talla:'',cantidad:0}; if(tempVariations.length){ const l=tempVariations[tempVariations.length-1]; last={estilo:l.estilo||'',color:l.color||'',talla:l.talla||'',cantidad:l.cantidad||0}; } tempVariations.push({id:Date.now(),...last}); openVariationsModal(); }
    function removeTempVariation(id){ tempVariations=tempVariations.filter(v=>v.id!==id); if(!tempVariations.length) tempVariations.push({id:Date.now(),estilo:'',color:'',talla:'',cantidad:0}); openVariationsModal(); }
    function closeVariationsModal(){ document.getElementById('variationsModal').style.display='none'; }

    async function saveAllVariations(){
      const valid=tempVariations.filter(v=>v.color&&v.talla&&v.cantidad>0);
      if(!valid.length){ showMessage('Sin variaciones','Agrega al menos una variaci√≥n v√°lida.','#dc3545'); return; }
      const MARCA=getFieldValue('marca'), DESCRIPCION=getFieldValue('descripcion'), GENERO=getFieldValue('genero');
      const PRECIOCOMPRA=parseFloat(document.getElementById('precioCompra').value)||0;
      const PRECIOVENTA =parseFloat(document.getElementById('precioVenta').value)||0;
      const FECHACREACION=new Date().toISOString().slice(0,10);
      const CATEGORIA=generateCategory(DESCRIPCION, GENERO);

      const products=valid.map(v=>({
        ID:`PROD_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,
        TIPO:'VARIACION',
        MARCA, DESCRIPCION, GENERO,
        ESTILO:(v.estilo||'').toUpperCase(),
        COLOR:(v.color||'').toUpperCase(),
        TALLA:(v.talla||'').toUpperCase(),
        CANTIDAD:v.cantidad,
        PRECIOCOMPRA, PRECIOVENTA, FECHACREACION, CATEGORIA
      }));

      const btn=document.querySelector('.save-variations-btn'); btn.disabled=true; btn.textContent='üíæ Guardando‚Ä¶';
      try{
        await apiCall('create_products',{ products });
        for(const p of products) await saveDataRowFromProduct(p);
        await loadAll(); showMessage('OK',`Se guardaron ${products.length} variaciones.`);
        tempVariations=[]; closeVariationsModal(); clearForm();
      }catch(err){ console.error(err); showMessage('Error', err.message, '#dc3545'); }
      finally{ btn.disabled=false; btn.textContent='üíæ Guardar Todas las Variaciones'; }
    }

    /* ================================
       LISTADO / FILTROS
       ================================ */
    function populateFilterOptions(){
      const cats=new Set(), brands=new Set();
      currentProducts.forEach(p=>{ if(p.categoria) cats.add(p.categoria); if(p.marca) brands.add(p.marca); });
      const categoryFilter=document.getElementById('categoryFilter');
      const brandFilter=document.getElementById('brandFilter');
      categoryFilter.innerHTML='<option value="">Todas las categor√≠as</option>';
      Array.from(cats).sort().forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categoryFilter.appendChild(o); });
      brandFilter.innerHTML='<option value="">Todas las marcas</option>';
      Array.from(brands).sort().forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; brandFilter.appendChild(o); });
    }
    function applyFilters(){
      const q=(document.getElementById('searchInput').value||'').toUpperCase();
      const category=document.getElementById('categoryFilter').value;
      const brand=document.getElementById('brandFilter').value;
      const type=document.getElementById('typeFilter').value;
      const sortBy=document.getElementById('sortBy').value;

      filteredProducts=currentProducts.filter(p=>{
        const s=!q || (p.marca||'').includes(q) || (p.descripcion||'').includes(q) || (p.color||'').includes(q) || (p.talla||'').includes(q) || (p.genero||'').includes(q) || (p.estilo||'').includes(q);
        const c=!category || p.categoria===category;
        const b=!brand || p.marca===brand;
        const t=!type || p.tipo===type;
        return s&&c&&b&&t;
      });

      filteredProducts.sort((a,b)=>{
        switch(sortBy){
          case 'fecha-desc': return new Date(b.fechaCreacion||0)-new Date(a.fechaCreacion||0);
          case 'fecha-asc':  return new Date(a.fechaCreacion||0)-new Date(b.fechaCreacion||0);
          case 'marca-asc':  return (a.marca||'').localeCompare(b.marca||'');
          case 'marca-desc': return (b.marca||'').localeCompare(a.marca||'');
          case 'descripcion-asc':  return (a.descripcion||'').localeCompare(b.descripcion||'');
          case 'descripcion-desc': return (b.descripcion||'').localeCompare(a.descripcion||'');
          case 'cantidad-desc': return (b.cantidad||0)-(a.cantidad||0);
          case 'cantidad-asc':  return (a.cantidad||0)-(b.cantidad||0);
          case 'precio-desc':   return (b.precioVenta||0)-(a.precioVenta||0);
          case 'precio-asc':    return (a.precioVenta||0)-(b.precioVenta||0);
          case 'ganancia-desc': return ((b.precioVenta||0)-(b.precioCompra||0))-((a.precioVenta||0)-(a.precioCompra||0));
          case 'ganancia-asc':  return ((a.precioVenta||0)-(a.precioCompra||0))-((b.precioVenta||0)-(b.precioCompra||0));
          default: return 0;
        }
      });

      document.getElementById('filterResults').textContent=`Mostrando ${filteredProducts.length} de ${currentProducts.length} productos`;
      updateProductsDisplay();
    }
    function resetFilters(){ document.getElementById('searchInput').value=''; document.getElementById('categoryFilter').value=''; document.getElementById('brandFilter').value=''; document.getElementById('typeFilter').value=''; document.getElementById('sortBy').value='fecha-desc'; filteredProducts=[...currentProducts]; updateProductsDisplay(); document.getElementById('filterResults').textContent=`Mostrando ${currentProducts.length} productos`; }
    function currency(n){ const v=Number(n||0); return v.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }

    function infoCard(label,value){ return `<div style="display:flex;flex-direction:column;padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:3px solid #28a745;"><span style="font-size:11px;font-weight:600;color:#999;margin-bottom:4px;">${label}</span><span style="color:#155724;font-weight:700;font-size:14px;">${value ?? '-'}</span></div>`; }
    function miniInfo(label,value){ return `<div style="background:#fff;padding:8px;border-radius:6px;border:1px solid #eee;font-size:12px;"><strong>${label}:</strong> ${value ?? '-'}</div>`; }

    function updateProductsDisplay(){
      const emptyState=document.getElementById('emptyState');
      const container=document.getElementById('productsContainer');
      const clearAllBtn=document.getElementById('clearAllBtn');
      const downloadBtn=document.getElementById('downloadBtn');
      const filterSection=document.getElementById('filterSection');

      populateFilterOptions();

      if(!currentProducts.length){
        emptyState.style.display='block'; container.innerHTML=''; clearAllBtn.style.display='none'; downloadBtn.style.display='none'; filterSection.style.display='none'; return;
      }
      emptyState.style.display='none'; clearAllBtn.style.display='block'; downloadBtn.style.display='block'; filterSection.style.display='block';

      const grouped={};
      filteredProducts.forEach(p=>{
        if(p.tipo==='simple'){ grouped[p.id]={type:'simple',product:p}; }
        else { const key=`${p.marca}_${p.descripcion}_${p.genero}`; if(!grouped[key]) grouped[key]={type:'variations',baseProduct:p,variations:[]}; grouped[key].variations.push(p); }
      });

      container.innerHTML='';
      Object.values(grouped).forEach(g=>{
        if(g.type==='simple'){
          const p=g.product; const gan=(p.precioVenta||0)-(p.precioCompra||0); const fecha=p.fechaCreacion?new Date(p.fechaCreacion).toLocaleDateString('es-ES'):'';
          const el=document.createElement('div'); el.className='product-simple';
          el.innerHTML=`
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
              <div>
                <div style="display:inline-block;background:rgba(40,167,69,.2);padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700;color:#155724;margin-bottom:8px;">PRODUCTO SIMPLE</div>
                <h3 style="font-size:22px;font-weight:700;color:#155724;margin:0;">${p.marca||'Sin marca'} - ${p.descripcion||'Sin descripci√≥n'}</h3>
              </div>
              <div style="display:flex;gap:8px;">
                <button style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;" onclick="editProduct('${p.id}')">Editar</button>
                <button style="background:#dc3545;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;" onclick="deleteProduct('${p.id}')">Eliminar</button>
              </div>
            </div>
            <div style="margin-bottom:16px;padding:12px;background:rgba(255,243,205,.5);border-radius:8px;border-left:4px solid #ffc107;">
              <div style="font-size:14px;color:#666;">
                <strong style="color:#155724;">Categor√≠a:</strong> <span style="font-weight:600;color:#155724;">${p.categoria||'SIN CATEGORIA'}</span> |
                <strong style="color:#155724;">Fecha:</strong> <span style="font-weight:600;color:#155724;">${fecha}</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
              ${infoCard('G√âNERO',p.genero)} ${infoCard('ESTILO',p.estilo)} ${infoCard('COLOR',p.color)} ${infoCard('TALLA',p.talla)}
              ${infoCard('CANTIDAD',p.cantidad)} ${infoCard('COMPRA',currency(p.precioCompra))} ${infoCard('VENTA',currency(p.precioVenta))} ${infoCard('GANANCIA',currency(gan))}
            </div>`;
          container.appendChild(el);
        } else {
          const base=g.baseProduct; const fecha=base.fechaCreacion?new Date(base.fechaCreacion).toLocaleDateString('es-ES'):'';
          const list=document.createElement('div'); list.className='product-with-variations';
          list.innerHTML=`
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
              <div>
                <div style="display:inline-block;background:rgba(255,152,0,.2);padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700;color:#e65100;margin-bottom:8px;">PRODUCTO CON VARIACIONES</div>
                <h3 style="font-size:22px;font-weight:700;color:#e65100;margin:0;">${base.marca||'Sin marca'} - ${base.descripcion||'Sin descripci√≥n'}</h3>
              </div>
              <div></div>
            </div>
            <div style="margin-bottom:16px;padding:12px;background:rgba(255,243,205,.5);border-radius:8px;border-left:4px solid #ffc107;">
              <div style="font-size:14px;color:#666;">
                <strong style="color:#e65100;">Categor√≠a:</strong> <span style="font-weight:600;color:#e65100;">${base.categoria||'SIN CATEGORIA'}</span> |
                <strong style="color:#e65100;">Fecha:</strong> <span style="font-weight:600;color:#e65100;">${fecha}</span>
              </div>
            </div>
            <div class="variations-list" id="varList"></div>`;
          const varList=list.querySelector('#varList');
          g.variations.forEach(v=>{
            const gan=(v.precioVenta||0)-(v.precioCompra||0);
            const card=document.createElement('div'); card.className='variation-card';
            card.innerHTML=`
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div><strong>${v.color||'-'}</strong> / <strong>${v.talla||'-'}</strong> ‚Äî Cant: <strong>${v.cantidad||0}</strong></div>
                <div style="display:flex;gap:8px;">
                  <button style="background:#007bff;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;" onclick="editProduct('${v.id}')">Editar</button>
                  <button style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;" onclick="deleteProduct('${v.id}')">Eliminar</button>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px;">
                ${miniInfo('Estilo',v.estilo)} ${miniInfo('Compra',currency(v.precioCompra))} ${miniInfo('Venta',currency(v.precioVenta))} ${miniInfo('Ganancia',currency(gan))}
              </div>`;
            varList.appendChild(card);
          });
          container.appendChild(list);
        }
      });
    }

    /* ================================
       EDITAR PRODUCTO (MODAL + SAVE)
       ================================ */
    async function editProduct(id){
      const p=currentProducts.find(x=>String(x.id)===String(id));
      if(!p){ showMessage('Error','Producto no encontrado','#dc3545'); return; }
      const modal=document.getElementById('editModal'); const fecha=p.fechaCreacion || new Date().toISOString().slice(0,10);

      modal.innerHTML=`
        <div class="modal-overlay"><div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Editar Producto</h2>
            <button class="close-modal-btn" onclick="closeEditModal()">Cerrar</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div class="form-group" style="margin:0;">
              <label>ID (no editable)</label>
              <input type="text" id="edit_id" value="${p.id}" disabled style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Tipo</label>
              <select id="edit_tipo" style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
                <option value="simple" ${p.tipo==='simple'?'selected':''}>SIMPLE</option>
                <option value="variation" ${p.tipo==='variation'?'selected':''}>VARIACION</option>
              </select>
            </div>
            <div class="form-group" style="margin:0;">
              <label>Marca</label>
              <input type="text" id="edit_marca" value="${p.marca||''}" list="marcasList" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Descripci√≥n</label>
              <input type="text" id="edit_descripcion" value="${p.descripcion||''}" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>G√©nero</label>
              <input type="text" id="edit_genero" value="${p.genero||''}" list="generosList" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Estilo</label>
              <input type="text" id="edit_estilo" value="${p.estilo||''}" list="estilosList" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Color</label>
              <input type="text" id="edit_color" value="${p.color||''}" list="coloresList" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Talla</label>
              <input type="text" id="edit_talla" value="${p.talla||''}" list="tallasList" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Cantidad</label>
              <input type="number" id="edit_cantidad" value="${p.cantidad||0}" min="0" style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Precio Compra</label>
              <input type="number" id="edit_precioCompra" value="${p.precioCompra||0}" step="0.01" min="0" style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Precio Venta</label>
              <input type="number" id="edit_precioVenta" value="${p.precioVenta||0}" step="0.01" min="0" style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Fecha de creaci√≥n</label>
              <input type="date" id="edit_fecha" value="${fecha}" style="padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
            <div class="form-group" style="grid-column:1/-1;margin:0;">
              <label>Categor√≠a</label>
              <input type="text" id="edit_categoria" value="${p.categoria||''}" style="text-transform:uppercase;padding:12px;border:2px solid #e1e5e9;border-radius:8px;">
            </div>
          </div>
          <button id="saveEditBtn" class="save-variations-btn" style="margin-top:20px;">üíæ Guardar Cambios</button>
        </div></div>`;
      modal.style.display='block';

      const descEl=document.getElementById('edit_descripcion');
      const genEl =document.getElementById('edit_genero');
      function recalcCat(){ document.getElementById('edit_categoria').value = generateCategory(descEl.value, genEl.value); }
      descEl.addEventListener('input',recalcCat); genEl.addEventListener('input',recalcCat);

      document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
        try{
          const prod=collectEditedProductForSheets();
          const btn=document.getElementById('saveEditBtn'); btn.disabled=true; btn.textContent='üíæ Guardando‚Ä¶';
          await apiCall('edit_product',{ product: prod });
          closeEditModal(); await loadAll(); showMessage('OK','Producto actualizado correctamente.');
        }catch(e){ console.error(e); showMessage('Error', e.message||'No se pudo editar', '#dc3545'); }
        finally{ const btn=document.getElementById('saveEditBtn'); btn.disabled=false; btn.textContent='üíæ Guardar Cambios'; }
      });
    }
    function collectEditedProductForSheets(){
      const ID=document.getElementById('edit_id').value;
      const tipoUi=document.getElementById('edit_tipo').value;
      const TIPO=(tipoUi==='variation')?'VARIACION':'SIMPLE';
      const MARCA=(document.getElementById('edit_marca').value||'').toUpperCase().trim();
      const DESCRIPCION=(document.getElementById('edit_descripcion').value||'').toUpperCase().trim();
      const GENERO=(document.getElementById('edit_genero').value||'').toUpperCase().trim();
      const ESTILO=(document.getElementById('edit_estilo').value||'').toUpperCase().trim();
      const COLOR=(document.getElementById('edit_color').value||'').toUpperCase().trim();
      const TALLA=(document.getElementById('edit_talla').value||'').toUpperCase().trim();
      const CANTIDAD=parseInt(document.getElementById('edit_cantidad').value)||0;
      const PRECIOCOMPRA=parseFloat(document.getElementById('edit_precioCompra').value)||0;
      const PRECIOVENTA =parseFloat(document.getElementById('edit_precioVenta').value)||0;
      const FECHACREACION=(document.getElementById('edit_fecha').value||'').trim();
      const CATEGORIA=(document.getElementById('edit_categoria').value||'').toUpperCase().trim();
      return {ID,TIPO,MARCA,DESCRIPCION,GENERO,ESTILO,COLOR,TALLA,CANTIDAD,PRECIOCOMPRA,PRECIOVENTA,FECHACREACION,CATEGORIA};
    }
    function closeEditModal(){ const m=document.getElementById('editModal'); m.style.display='none'; m.innerHTML=''; }

    /* ================================
       EXTRAS
       ================================ */
    async function deleteProduct(id){ if(!confirm('¬øEliminar este producto?')) return; try{ await apiCall('delete_product',{id}); await loadAll(); showMessage('Eliminado','Producto eliminado correctamente.'); }catch(e){ showMessage('Error', e.message,'#dc3545'); } }
    function clearForm(){ document.getElementById('marca').value=''; document.getElementById('descripcion').value=''; document.getElementById('genero').value=''; document.getElementById('estilo').value=''; document.getElementById('color').value=''; document.getElementById('talla').value=''; document.getElementById('cantidad').value=''; document.getElementById('precioCompra').value=''; document.getElementById('precioVenta').value=''; setProductType('simple'); tempVariations=[]; }
    function clearAllProducts(){ alert('La limpieza total ahora debe hacerse en Google Sheets. Si quieres, agrego un bot√≥n que borre TODO con confirmaci√≥n.'); }
    function downloadCSV(){ const rows=[['ID','TIPO','MARCA','DESCRIPCION','GENERO','ESTILO','COLOR','TALLA','CANTIDAD','PRECIOCOMPRA','PRECIOVENTA','FECHACREACION','CATEGORIA']]; currentProducts.forEach(p=>rows.push([p.id,p.tipo,p.marca,p.descripcion,p.genero,p.estilo,p.color,p.talla,p.cantidad,p.precioCompra,p.precioVenta,p.fechaCreacion,p.categoria])); const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='productos.csv'; a.click(); URL.revokeObjectURL(url); }
    function analyzeDatabase(){ alert('An√°lisis local. Si quieres, creo un tablero de KPIs desde Sheets.'); }
    function openImportModal(){ alert('Importaci√≥n CSV local. Si quieres, la conecto a Sheets.'); }
    document.getElementById('refreshBtn').addEventListener('click', loadAll);

    /* ================================
       INICIO
       ================================ */
    async function init(){ try{ if(window.elementSdk) await window.elementSdk.init({ defaultConfig:{ app_title:"Sistema de Productos con Variaciones" } }); }catch(e){} setProductType('simple'); await loadAll(); }
    init();
  </script>
</body>
</html>
